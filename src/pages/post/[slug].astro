---
import Layout from '../../layouts/Layout.astro';
import { createClient } from '@supabase/supabase-js';
import { marked } from 'marked';
import DOMPurify from 'isomorphic-dompurify';

export async function getStaticPaths() {
  const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
  const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
  const supabase = createClient(supabaseUrl, supabaseKey);
  const { data: posts } = await supabase.from('posts').select('*');
  
  return posts?.map((noticia) => ({
    params: { slug: noticia.slug },
    props: { noticia },
  }));
}

const { noticia } = Astro.props;

// 1. CONVERTIMOS MARKDOWN A HTML
const rawHTML = marked.parse(noticia.content, { breaks: true });

// 2. SANITIZAMOS (SEGURIDAD)
const cleanHTML = DOMPurify.sanitize(rawHTML);

// 3. GENERAMOS RESUMEN SEO (Limpiamos s√≠mbolos de markdown # o *)
// Si existe excerpt lo usamos, si no, limpiamos el HTML del content
const resumenSEO = noticia.excerpt 
  ? noticia.excerpt 
  : noticia.content.replace(/<[^>]*>?/gm, '').substring(0, 160) + "...";
---

<Layout 
  title={noticia.title} 
  description={resumenSEO}
  image={noticia.image_url} 
>
  <main class="max-w-3xl mx-auto px-4 py-12">
    
    <a href="/" class="inline-flex items-center text-gray-400 hover:text-cyan-400 mb-12 transition-colors group text-sm font-medium">
      <svg class="w-4 h-4 mr-2 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
      Volver al inicio
    </a>

    <article>
      {noticia.image_url && (
        <div class="mb-10 rounded-xl overflow-hidden shadow-2xl shadow-cyan-900/20 border border-white/10 aspect-video relative">
          <img 
            src={`https://wsrv.nl/?url=${encodeURIComponent(noticia.image_url)}&w=1200&q=90`} 
            alt={noticia.title}
            class="w-full h-full object-cover"
            transition:name={`image-${noticia.slug}`} 
            referrerpolicy="no-referrer"
          />
          <div class="absolute inset-0 bg-gradient-to-t from-[#0a0a0a] via-transparent to-transparent opacity-60"></div>
        </div>
      )}

      <h1 class="text-4xl md:text-5xl font-extrabold text-white mb-8 leading-tight tracking-tight">
        {noticia.title}
      </h1>

      <div class="flex items-center gap-4 text-sm text-gray-400 mb-12 border-b border-white/10 pb-8">
        <span class="bg-blue-900/30 text-blue-300 px-3 py-1 rounded-full border border-blue-500/30 text-xs font-semibold uppercase tracking-wider">IA Generated</span>
        <span>
          {new Date(noticia.created_at).toLocaleDateString('es-ES', {
            day: 'numeric',
            month: 'long',
            year: 'numeric'
          })}
        </span>
      </div>

      <div 
        class="
          prose prose-lg prose-invert max-w-none 
          prose-p:text-gray-300 prose-p:my-6 prose-p:leading-relaxed
          prose-headings:text-cyan-100 prose-headings:font-bold prose-headings:mt-12 prose-headings:mb-6 prose-headings:text-2xl
          prose-strong:text-cyan-400 prose-strong:font-bold
          prose-ul:list-disc prose-ul:pl-5 prose-li:my-2
          prose-a:text-cyan-400 prose-a:underline hover:prose-a:text-cyan-300
        "
        set:html={cleanHTML} 
      />
    </article>

  </main>
</Layout>